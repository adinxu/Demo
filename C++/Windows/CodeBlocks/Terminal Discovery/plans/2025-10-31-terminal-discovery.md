# 终端发现代理实施计划

## 范围与关联规范
- **目标**：依据 `specs/2025-10-31-terminal-discovery.md` 中的最新需求与约束，构建可跨平台移植的终端发现代理，首期聚焦 Realtek 平台，并确保与外部 C++ 北向接口的 ABI 兼容。
- **关联规范**：`specs/2025-10-31-terminal-discovery.md`

## 假设与非目标
- Realtek 平台具备 Raw Socket 能力并允许绑定 VLAN 虚接口（如 `vlan1`），推荐交叉编译前缀为 `mips-rtl83xx-linux-`（如 `mips-rtl83xx-linux-gcc`）；若该工具链暂不可用，可使用通用 MIPS 交叉工具链验证代码可编译性。
- 设备启动阶段已默认为所有二层口启用 ARP Copy-to-CPU ACL，适配器无需额外校验或感知该配置。
- 设备上存在网络测试仪或等效工具，可模拟 ≥300 个终端。
- 暂不考虑软件层面的 ARP 限速策略；若后续平台启用，需要重新评估。
- 外部团队提供的 C++ API（`MAC_IP_INFO` 及相关回调）按约定稳定，且允许我们在构建链中启用 C/C++ 混合编译。
- 项目默认采用 C 语言实现；仅在对接外部 C++ ABI 时引入必要的桥接代码。
- 当前回调/查询仅要求输出 `mac` 与 `ip` 字段，未来扩展将另行评估，并需支持 0–3600 秒的节流配置。
- 开发环境为 x86，而目标 Realtek 平台为 MIPS；与硬件相关的测试需在目标平台上手动运行与验证。
- 不在本轮实现 CLI/UI、DHCP/ND 嗅探或与 FIB 的深度集成。

## 分阶段计划

### 阶段 0：Realtek Demo 验证
1. 搭建测试环境：网络测试仪与目标交换机实连，确保 `eth0` 抓取/发送能力正常。
2. 编写最小 Raw Socket demo（以 C 语言实现）：
   - 接收端监听 `eth0` 并应用 BPF 过滤器（实现见 `src/demo/stage0_raw_socket_demo.c`）。
   - 发送端绑定 `vlan1`，周期性下发 ARP request；使用同一程序的 `--tx-iface` 参数可切换接口。
   - 确认收包路径正确解析 VLAN tag（无 CPU tag）。
3. 使用网络测试仪模拟至少 300 个终端：
   - 验证发现、保活及上报节流逻辑的可行性。
   - 记录 CPU、内存占用，统计丢包/超时情况，并确认 100ms 发包节奏满足竞分约束。
4. 汇总验证结果与瓶颈分析，为后续方案设计提供输入。

### 阶段 1：适配层设计与实现
1. 设计 `adapter_api.h` 接口，明确回调、错误码与资源生命周期。
2. 实现 Realtek 适配器骨架：
   - 使用可移植的线程/锁与事件循环（epoll/poll/自定义）。
   - 集成 Raw Socket+BPF 接收链路，保持与 demo 一致，解析 VLAN tag 并映射 Access/Trunk 上下文。
   - 在 VLAN 虚接口上发送 ARP keepalive，无需 SDK 依赖，并按 100ms 节奏分散探测报文。
3. 补充配置加载与日志抽象，支持运行时切换适配器或调试级别。

### 阶段 2：核心终端引擎
1. 实现终端数据结构、状态机（ACTIVE/PROBING/IFACE_INVALID）。
2. 引入时间轮或小根堆调度器，驱动保活与超时删除，支持 30 分钟保留策略与单终端定时。
3. 处理接口事件：跟踪 VLAN 虚接口创建删除、IP 变更、UP/DOWN，并在 Access/Trunk/PVID 规则触发时切换状态。

### 阶段 3：报文解码与事件上报
1. 完成 ARP 解析模块，归一化 VLAN/接口上下文（含 Access/Trunk、PVID 判定）并触发状态更新。
2. 实现增量事件队列，支持节流窗口聚合；定义二进制 TLV 输出，如北向改用 JSON，需额外评估影响。
3. 实现全量查询 API，返回有序终端快照。
4. 设计 C `extern "C"` 桥接层，封装 `getAllTerminalIpInfo`、`setIncrementReportInterval` 等 C++ 实现，保证异常被捕获并写日志。
5. 在桥接层中构建/转换 `MAC_IP_INFO`，仅填充 `mac`、`ip` 字段，同时保留扩展钩子以便后续增加字段时无需破坏现有接口。
6. 定义回调派发策略（复制数据异步投递），防止上层阻塞核心线程。
7. 串行化 `getAllTerminalIpInfo` 与节流配置更新，避免查询与回调同时访问导致竞态。

### 阶段 4：配置、日志与文档
1. 提供配置接口/文件读取，允许调整探测间隔、节流窗口等参数。
2. 集成结构化日志与基础指标（探测数、丢包数等）。
3. 编写开发者指南，说明构建、部署、适配器扩展方法以及 C/C++ 混合编译配置与接口契约（当前仅包含 `mac`、`ip` 字段的输出约定与节流配置范围）。

### 阶段 5：测试与验收
1. 编写单元测试覆盖状态机、超时与事件节流逻辑，包括 30 分钟保留与接口恢复场景。
2. 实现基于 mock 适配器的集成测试（发现、保活、接口波动）。
3. 为 C/C++ 桥接层补充单元测试与回调桩测试，覆盖异常捕获、字段完整性（仅 `mac`、`ip`）、全量查询排序；核心逻辑侧保持 C 语言实现，桥接层仅封装 ABI 差异。
4. 重跑 Realtek 平台 300 终端 demo，确认 VLAN tag 解析与 100ms 发包节奏满足指标。
5. 进行 1000 终端压力试验（如可行），采集性能数据。
6. 执行 C++ 接口联调测试：
   - 验证 `getAllTerminalIpInfo` 稳定排序与空结果返回。
   - 验证 `setIncrementReportInterval` 0–3600 秒范围及非法值返回。
   - 验证增量回调节流窗口（0–3600 秒）与异常保护逻辑。
   - 确认回调输出仅包含 `mac`、`ip` 字段。
7. 汇总测试报告，并准备回滚策略文档。

## 依赖与风险
- 依赖网络测试仪能稳定模拟大规模 ARP 终端。
- Raw Socket 权限或平台安全策略可能阻止绑定 VLAN 虚接口。
- Trunk 口在部分 VLAN 未建虚接口的报文行为仍待实验确认，可能影响终端保活策略。
- 事件负载格式需与系统集成团队确认（二进制 TLV vs JSON），若格式变更将影响上报模块设计。
- 接口事件源（netlink/SDK）若行为差异大，需追加适配层开发。

## 验证策略
- 单元测试：状态机、定时器、事件节流。
- 集成测试：使用 mock 适配器模拟报文与接口事件。
- 实机测试：Realtek 平台 300 终端 demo；若资源允许扩展到 1000。
- 性能监测：CPU、内存、报文速率、探测成功率，覆盖 200/300/500/1000 终端档位。
- 由于平台差异，所有实机验证步骤需在 MIPS 目标环境手动执行，并记录操作过程与结果。

## 审批与下一步
- 当前状态：阶段 0 执行中（2025-11-01 更新）。
- 下一步：完成 Raw Socket demo 实机验证并整理报告后，评估进入阶段 1 的条件，并确认北向事件负载格式（TLV/JSON）。
