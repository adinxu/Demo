# 终端发现代理实施计划

## 范围与关联规范
- **目标**：依据 `specs/2025-10-31-terminal-discovery.md` 中的最新需求与约束，构建可跨平台移植的终端发现代理，首期聚焦 Realtek 平台，并确保与外部 C++ 北向接口的 ABI 兼容。
- **关联规范**：`specs/2025-10-31-terminal-discovery.md`

## 假设与非目标
- Realtek 平台具备 Raw Socket 能力并允许绑定 VLAN 虚接口（如 `vlan1`），推荐交叉编译前缀为 `mips-rtl83xx-linux-`（如 `mips-rtl83xx-linux-gcc`）；若该工具链暂不可用，可使用通用 MIPS 交叉工具链验证代码可编译性。
- 终端发现逻辑仅依赖入方向 ARP 报文；适配器需在收包侧过滤掉本机发送的 ARP，避免无意义事件，并在内核剥离 VLAN tag 时通过 `PACKET_AUXDATA` 取回原始 VLAN。
- 设备启动阶段已默认为所有二层口启用 ARP Copy-to-CPU ACL，适配器无需额外校验或感知该配置。
- 设备上存在网络测试仪或等效工具，可模拟 ≥300 个终端。
- 暂不考虑软件层面的 ARP 限速策略；若后续平台启用，需要重新评估。
- 外部团队提供的 C++ API（`MAC_IP_INFO` 及相关回调）按约定稳定，且允许我们在构建链中启用 C/C++ 混合编译。
- 项目默认采用 C 语言实现；仅在对接外部 C++ ABI 时引入必要的桥接代码。
- 当前回调/查询仅要求输出 `mac` 与 `ip` 字段，并以字符串形式携带这两个字段；未来扩展将另行评估，并需支持 0–3600 秒的节流配置。
- 开发环境为 x86，而目标 Realtek 平台为 MIPS；与硬件相关的测试需在目标平台上手动运行与验证。
- 不在本轮实现 CLI/UI、DHCP/ND 嗅探或与 FIB 的深度集成。

## 分阶段计划

### 阶段 0：Realtek Demo 验证（已完成）
1. ✅ 搭建测试环境：网络测试仪直连交换机，确认 `eth0` 具备 Raw Socket 收发能力，VLAN1 对应虚接口可成功发包。
2. ✅ 开发 `src/demo/stage0_raw_socket_demo.c`：
   - 接收端固定监听 `eth0`，加载 BPF 过滤器并启用 `PACKET_AUXDATA` 恢复 VLAN；收到 ARP 时打印 opcode/VLAN/源目标信息，可选择十六进制转储。
   - 发送端允许指定 `--tx-iface`、源/目的 MAC/IP、间隔、次数；默认绑定 `vlan1`，周期性下发 ARP 请求。
3. ✅ 实机验证（基础）：确认 RX 能恢复 VLAN、忽略本机发送帧；TX 在 `vlan1` 下发 ARP 且保持 100ms 间隔。
4. ⚠️ 待补充：300 终端规模模拟尚未执行，需补充性能指标（CPU/内存、丢包率）、网络测试仪配置步骤及异常日志样例。

### 阶段 1：适配层设计与实现（已完成）
1. ✅ ABI 设计：`src/include/adapter_api.h` 定义错误码、日志级别、报文视图、接口事件、计时器、ARP 请求结构；`src/include/td_adapter_registry.h` + `src/adapter/adapter_registry.c` 注册并解析唯一 Realtek 适配器描述符。
2. ✅ Realtek 适配器：
   - RX：`realtek_start` 时创建 `AF_PACKET` 套接字，附加 BPF、`PACKET_AUXDATA`，在 `rx_thread_main` 中恢复 VLAN、ifindex、MAC 并回调。
   - TX：`realtek_send_arp` 使用 `send_lock` 节流；优先采用请求内 `tx_iface`，缺省回落到配置接口；必要时调用 `SO_BINDTODEVICE`、查询接口 IPv4/MAC，若接口无 IP 则跳过并记录日志。
   - 接口与定时器：基于标准 netlink 订阅接口事件（监听 VLANIF 上下线、IP 变更、flags 改动），定时逻辑采用 Linux 单调时钟相关 API，避免系统时间调整对节奏造成影响。
   - 生命周期：实现 `init/start/stop/shutdown`，确保线程安全关闭；未实现的接口事件/定时器将返回 `UNSUPPORTED` 并记录告警。
3. ✅ 公共组件：
   - `td_config_load_defaults` 提供统一的默认运行配置（适配器名称 `realtek`、`eth0`/`vlan1`、100ms 节流、INFO 日志级别）。
   - `td_log_writef` 提供结构化日志输出与外部注入能力。

### 阶段 2：核心终端引擎
1. 终端表与状态机：
   - `terminal_entry` 记录 MAC/IP、Ingress/VLAN 元数据、`tx_iface` 绑定、`last_seen/last_probe/failed_probes`。
   - 状态流转：`ACTIVE ↔ PROBING` 基于报文/保活结果，接口失效或跨网段进入 `IFACE_INVALID` 并保留 30 分钟。
2. 调度策略：
   - 初始实现采用固定周期（默认 1s，可配置）遍历整个哈希表；计算与配置项关联的保活/过期条件并触发探测。
   - ⚠️ 待评估：扫描周期与 CPU 负载基线尚未量化，需要后续实测；若不满足性能指标再引入时间轮或小根堆。
3. 保活执行：
   - 调用注入的 `probe_cb` 生成 `td_adapter_arp_request`，填充 `tx_iface/tx_ifindex`，委托适配器发送。
   - 失败计数达到 `keepalive_miss_threshold` 删除终端并记录事件。
4. 接口感知：
   - `tx_iface/tx_ifindex` 取自终端最近一次有效报文绑定的入口信息（`terminal_entry` 中的 ingress 记录），保活前如有新报文会同步刷新。
   - 入口信息解析需结合 VLAN tag 完成平台映射：例如 Realtek 平台 VLAN1 对应接口名 `vlan1`，而 GNOS 平台为 `Vlan1`，终端记录时需存储原始 VLAN ID 并在发包前转换为平台实际接口名。
   - 从适配器/平台事件同步接口状态；Realtek 平台默认通过标准 netlink 订阅 VLANIF 上下线、IP 变更、flags 变更。
   - Trunk 口的 VLAN permit 已由底层 ACL 规则保障，当前阶段不额外获取许可列表；若未来平台行为变更，再评估是否需补充判定流程。
5. 并发与锁：使用互斥量保护哈希桶，对外暴露线程安全 API；针对定时扫描线程与报文线程的协作需写明确步骤。

### 阶段 3：报文解码与事件上报
1. 报文解析：
   - 将阶段 1 适配器回调的 `td_adapter_packet_view` 转换为内部事件，补齐 VLAN/接口上下文并校验 IP 与接口网段。
   - 依赖 ACL 提供的 VLAN tag 判定终端归属；无需再查询 Access/Trunk 配置，仅在缺失对应 VLANIF 时按三层 Down 逻辑处理（如平台后续引入无标签报文，再补充 PVID 判定）。
2. 事件队列：
   - 构建新增/删除/修改三类事件；按照节流窗口聚合后上报。
   - 支持自定义节流秒级配置，默认 0 表示实时。
3. 北向接口：
   - C API 提供查询 (`terminal_query_all`) 与订阅 (`terminal_subscribe`)；C++ 桥接层包装外部 `MAC_IP_INFO`/回调。
   - 轮询与回调串行化，避免竞态；异常捕获后写日志并保护运行。
4. ⚠️ 待补充：增量事件的数据结构及持久化策略尚未定稿。

### 阶段 4：配置、日志与文档
1. 配置体系：
   - 扩展 `td_config` 支持终端保活间隔、失败阈值、节流窗口、最大终端数量等参数；后续引擎统一从配置文件读取，暂不使用环境变量通道。
2. 日志与指标：
   - 引入核心模块结构化日志标签（如 `terminal_manager`, `event_queue`）。
   - 暴露探测计数、失败数、接口波动等指标，预留对接 Prometheus 或 CLI 的采集口。
3. 文档：
   - 编写阶段 2+ 核心引擎设计说明、API 参考、构建部署指南。

### 阶段 5：测试与验收
1. 单元测试：覆盖状态机（含 30 分钟保留）、接口事件恢复、节流窗口逻辑；使用 mock 终端表验证遍历调度正确性。
2. 集成测试：基于模拟适配器重放报文、接口事件；验证保活探测、删除、接口失效恢复、事件聚合。
3. 北向测试：
   - C/C++ 桥接层回调桩，验证异常捕获、字段完整性、节流配置上下界。
   - 全量查询排序与并发访问。
4. 实机/压力验证：
   - 300 终端 Realtek Demo 回归；1k 终端压力测试记录 CPU/内存/丢包。
5. 验收输出：整理测试报告、回滚策略、性能曲线。

## 依赖与风险
- 依赖网络测试仪能稳定模拟大规模 ARP 终端。
- Raw Socket 权限或平台安全策略可能阻止绑定 VLAN 虚接口。
- Trunk 口在部分 VLAN 未建虚接口的报文行为仍待实验确认，可能影响终端保活策略。
- 事件负载格式需与系统集成团队确认（二进制 TLV vs JSON），若格式变更将影响上报模块设计。
- 接口事件源（netlink/SDK）若行为差异大，需追加适配层开发。

## 验证策略
- 单元测试：状态机、定时器、事件节流。
- 集成测试：使用 mock 适配器模拟报文与接口事件。
- 实机测试：Realtek 平台 300 终端 demo；若资源允许扩展到 1000。
- 性能监测：CPU、内存、报文速率、探测成功率，覆盖 200/300/500/1000 终端档位。
- 由于平台差异，所有实机验证步骤需在 MIPS 目标环境手动执行，并记录操作过程与结果。

## 审批与下一步
- 当前状态：阶段 2 需求梳理中（2025-11-01 更新）。
- 下一步：进入阶段 2，围绕终端核心引擎的数据结构、定时器与接口事件处理展开设计，并复核字符串格式北向负载需求。
