# 终端发现代理规范

## 问题陈述与背景
- 交付一个可复用的 C/C++ 终端发现代理，能够运行在异构交换机操作系统上（首期适配 Realtek SDK，后续覆盖 Netforward/Linux 等变体）。
- 通过过路的二层报文识别终端、维护存活状态，并以最小的特定平台代码将终端状态暴露给交换设备的上层模块。

## 目标
- 通过检查二层控制报文发现终端（当前聚焦 ARP，可扩展至 DHCP 等协议）。
- 通过主动探测与定时淘汰维护每个终端的生命周期。
- 引入可插拔的适配层，隔离 Realtek 等平台的硬件/内核差异。
- 提供可编程查询接口和带速率限制的增量通知，满足网络管理系统的消费需求。
- 在 ARM64、MIPS、x86 等不同 CPU 体系和报文收发架构间保持可移植性。

## 非目标
- 本阶段不实现完整的 DHCP/ND 嗅探能力。
- 不管理三层路由逻辑，也不直接操控 FIB/ARP 表，除非与终端跟踪相关。
- 不提供 UI/CLI 集成，仅关注后端接口。

## 功能性需求
1. **终端发现**：处理 ARP 广播、免费 ARP、单播回复等，按 VLAN/接口识别终端。
2. **保活机制**：每个终端每 120 秒发送一次 ARP request；连续三次无响应则删除终端。
3. **接口感知**：追踪三层 VLAN 接口生命周期（创建/删除/上下线、IP 变更），接口无效时暂停保活。
4. **Access/Trunk 逻辑**：根据 VLAN 成员关系判定；无标签时回退到 PVID。
5. **拓扑边界场景**：当关联的三层接口 down 或 VLAN 缺少接口时保留 30 分钟，恢复后继续探测。
6. **多网卡支持**：兼容单网卡和多网卡设备，同时允许多个适配器并行工作。
7. **事件上报**：
   - 支持配置最小时间间隔的增量变更通知。
   - 支持查询当前终端表的全量快照。
8. **可配置项**：
   - 每站点可配置通知节流间隔。
   - 启动时可选择平台适配器。

## 非功能性需求
- **性能**：在 ARM64 参考平台上，1k 终端负载时单核占用 <10%，并在当前未启用软件 ARP 限速的假设下仍需确保无报文丢失。
- **能力验证**：在 Realtek 平台先行完成 300 终端规模的 demo 验证，确认收发链路、保活节奏与上报机制满足指标。
- **可靠性**：确保无终端泄漏；并发访问需线程安全。
- **可移植性**：核心逻辑仅依赖 POSIX 类原语与适配器回调。
- **可观测性**：输出结构化日志（级别-标签-消息），并可选导出探测、响应、过期、队列丢弃等计数器。
- **可测试性**：提供平台无关的状态机单测，以及基于适配器 mock 的发现/保活集成测试。

## 架构概览
- **核心服务层**：处理终端表、定时器、状态转换和报表生成的跨平台模块。
- **平台适配接口（PAI）**：抽象报文收发、接口事件、时钟/定时器等平台差异。
  - 必备回调：`adapter_init`、`register_packet_rx`、`send_arp`、`query_iface`、`subscribe_iface_events`、`schedule_timer`、`log_write`。
   - 参考实现：`realtek_adapter`、`netforward_adapter`、`linux_rawsock_adapter`。
- **事件总线**：内部队列在节流窗口内聚合终端变更并投递给上报子系统。
- **API 接口**：提供 `terminal_query_all`、`terminal_subscribe`、`terminal_config_set` 等 C API。
 - **API 接口**：内部实现需兼容外部团队计划提供的 C++ API，用于事件上报与全量查询。

## 参考实现提示
- **Realtek 参考代码约束**：
   - 可参考 `src/ref/realtek/loop_protect.c` 的线程、互斥量等 OSA 抽象，但实现可自行选择 POSIX 线程/锁等通用原语，无需强绑 OSA 框架。
   - 复用 Raw Socket + BPF 过滤模型，确保适配器初始化时设置专用过滤器以截获目标广播报文。
   - 事件循环可按功能设计（如 epoll、poll 或自定义调度），不强制依赖 `loop_protect_epoll_loop` 实现。
   - 报文发送通过 Raw Socket 直接绑定至 VLAN 对应的虚接口（例如 VLAN1 对应 `vlan1`），填充 ARP request 后发出，避免引入 SDK 依赖。
   - 报文接收侧需监听物理网卡 `eth0`，结合 BPF 过滤筛选关心的报文。
- **北向 API 约束**：
    - 预计由外部团队提供以下接口，终端发现模块需兼容其调用方式并支持 C/C++ 混合编译：
       - `typedef std::vector<std::map<std::string, std::string>> MAC_IP_INFO;`
       - `typedef void IncReportCb(const MAC_IP_INFO &add, const MAC_IP_INFO &del, const MAC_IP_INFO &mod);`
       - `int getAllTerminalIpInfo(MAC_IP_INFO &allTerIpInfo);`
       - `int setIncrementReportInterval(int second, IncReportCb cb);`
    - C 入口层需通过 `extern "C"` 桥接封装，将 C 调用转换为 C++ 实现；禁止跨 ABI 抛出异常，所有异常在桥接层内部捕获并写日志。
    - `MAC_IP_INFO` 中 map 的必填键仅包含 `mac` 与 `ip`；其他字段暂不输出，若未来需要扩展需在文档中声明并保证前向兼容。
    - 增量上报间隔以最近一次成功调用 `getAllTerminalIpInfo` 为起点；内部需串行化重置逻辑，避免查询与回调同时访问导致竞态。
    - `setIncrementReportInterval` 需支持 0–3600 秒范围，非法入参返回错误码并保留旧配置。
    - 若回调阻塞或发生异常，模块需记录结构化日志，并在必要时触发一次空 `mod` 列表的告警回调提醒上层处理。

## 详细行为
- **报文路径**：
  1. 适配器上报入方向帧的元数据（MAC、VLAN、入接口、时间戳）给发现引擎。
  2. 引擎归一化 VLAN/接口上下文，更新或创建 `terminal_entry` 状态，并入队变更事件。
- **保活循环**：
  - 独立定时线程通过小根堆或时间轮取出到期终端，经适配器调用 `send_arp`。
  - 探测失败计数递增；第三次失败后移除条目并发出删除事件。
- **接口状态跟踪**：
  - 适配器上报接口上下线/IP 事件。
  - 引擎将受影响终端置为 `IFACE_INVALID`，直至接口重新有效。
- **并发模型**：
  - 终端核心数据使用读写锁保护；定时线程与报文线程的写操作通过串行化任务队列执行。
  - 上报线程消费事件队列，在节流窗口内聚合并批量下发通知。

## 任务拆解
0. **Realtek Demo 验证**
   - 使用网络测试仪构造至少 300 个虚拟终端，验证现有 Raw Socket 收发链路、保活探测与上报节流逻辑满足性能与稳定性要求。
   - 记录测试方法、日志与瓶颈观察结论，作为后续方案设计与编码的输入。
1. **平台适配框架**
   - 定义 `adapter_api.h` 接口及默认 POSIX 工具。
   - 实现 Realtek 适配器骨架：使用可移植的线程/锁与事件循环抽象（POSIX 或平台特有实现均可），结合 Raw Socket+BPF 过滤；发送路径在 VLAN 虚接口（如 `vlan1`）上通过 Raw Socket 构造并下发 ARP 请求，无需使用 SDK 报文发送库。
2. **终端核心引擎**
   - 编写终端数据结构、生命周期状态机与锁策略。
   - 集成时间轮或小根堆调度器，驱动探测与过期。
3. **报文解码模块**
   - 解析 ARP 帧，提取 VLAN/接口上下文，做输入校验并通知发现引擎。
   - 预留扩展挂钩，以支持未来的 DHCP。
4. **上报与 API 层**
   - 实现带节流的变更通知队列。
   - 提供稳定排序的同步查询接口。
   - 定义输出负载（MAC/IP/VLAN/端口/状态/时间戳 的二进制 TLV），并撰写格式文档。
5. **配置与 CLI 钩子**
   - 提供配置结构体/环境加载器，用于适配器选择、节流、探测间隔、终端阈值。
6. **日志与遥测**
   - 集成分级日志宏；暴露探测、响应、过期等计数器。
7. **测试体系**
   - 编写状态机单测（ACTIVE↔PROBING↔IFACE_INVALID）。
   - 构建适配器 mock 测试覆盖发现、探测成功/失败、接口波动等场景。
   - 搭建性能基准，使用合成事件验证 1000 终端的时间行为。
8. **文档**
   - 输出开发者指南，涵盖适配器契约、构建说明与测试执行方式。

## 验收准则
- 发现状态机与定时驱动逻辑的单测全部通过。
- 基于 mock 的集成测试覆盖发现、保活成功/失败、接口上下线恢复、节流批量等场景。
- 在实验环境中验证 Realtek 适配器的 ARP 收发，保留抓包证据。
- 在参考硬件上进行 1000 终端的 CPU 剖析，满足性能目标。
- 提供 Realtek 平台 300 终端 demo 验证报告，包含测试步骤、网络测试仪配置、观察的资源占用与问题结论。
- 日志为结构化格式，计数器可通过调试接口或日志输出查看。
- 在 C/C++ 混合编译环境下完成 `getAllTerminalIpInfo` 与 `setIncrementReportInterval` 接口的联调验收，验证全量查询排序、增量回调节流与异常保护行为，并确认回调输出仅包含 `mac`、`ip` 字段。

## 替代方案评估
- 为每个终端创建线程执行保活（因扩展性差而否决）。
- 利用内核态 eBPF 实现 ARP 嗅探（因可移植性成本高而暂缓）。

## 未决问题
- Realtek 平台上，当 trunk 口混合存在未建虚接口的 VLAN 时的报文行为需在实验室确认。
- 事件负载的消费者使用的格式（计划采用的二进制 TLV 还是改为 JSON）仍需与系统集成团队确认，避免接口不匹配。

## 发布与回退策略
- 通过运行时配置开关控制特性，禁用适配器初始化即可回退。
- 回退时停止服务并移除钩子，运行态缓存之外无持久状态。
- 遥测：监控探测计数与节流队列长度，以捕捉潜在回归。
