
# 目标
目前需要实现一个通用的，可跨平台移植(例如arm64,mips)的c程序，实现二层报文处理功能，其运行平台为不同的交换机操作系统。目前暂时只实现reltek平台。
# 需求分析
## 功能性需求
1.	终端发现:通过过路报文(当前arp报文，支持后续可扩展(比如dhcp报文))识别终端
2.	终端保活:针对每个终端独立定时单播arp request保活(从发现开始计时，每两分钟一次)，连续三次无响应则删除终端
3.	特殊情况:直连三层口down，终端仍然会存在(30min)，但不发送报文保活,如果三层口up，会继续进行保活探测。Vlan无对应虚接口或有虚接口但ip和终端不在一个网段，处理同三层口down，如果新建了虚接口或ip改为同一网段，也会重新保活。
4.	能够在多网卡与单网卡设备上工作
5.	需要在终端变化时实现批量上报及全量终端查询接口，并支持设置上报最小间隔时间(避免频繁上报)


## 非功能性需求
1.	性能需求:1.应对大量报文上cpu(已有arp限速) 2.终端数量规格(根据设备能力有:200,300,500,1000等不同终端数) 
2.	可移植性:一定程度上可移植到其他的平台
3.	可维护性: 保持核心逻辑清晰，易于理解、维护和扩展。
4.	兼容性:适配不同的交换机平台(收包架构不同导致的方案差异，比如通用收包，内核收包，用户态收包)
5.	可调试性:完善的日志与清晰解耦的模块间接口，方便定位调试
# 可行性分析
##	接口管理
###	Reltek平台
####	接口类型
二层口(普通口和聚合口)
三层vlan虚接口
####	二层口模式
Access
Trunk
####	接口up/down
三层口通过netlink

###	Netforward平台
###	通用linux平台
##	报文收发
###	Reltek平台
#### Arp报文上送
默认创建虚接口时才下发acl规则，因此新适配代码(已完成)，在设备启动时默认所有二层口都上送arp报文(copy to cpu)。

接口对应vlan无vlan虚接口时:
广播arp(含免费arp):
单播request(所有)
单播reply(所有)

有虚接口时:
还会匹配目的mac和vlan tag是否和虚接口匹配

待确认:
Trunk口有的permit vlan无虚接口，有的有虚接口时的收包行为
####	收发包架构
网卡sdk在内核收包，用户态通过raw socket使用bpf过滤收包
####	内核报文处理
收发包时arp不携带cpu tag，但会有vlan tag

在收包时，哪里进行cpu tag剥离的？在抓包钩子点前
在发包时，组装好报文使用raw socket向三层口发送即可，不需要查二层转发表
###	Netforward平台
###	通用linux平台
# 概要设计

# 详细设计
##	接口管理
关心三层虚接口up/down
不关心二层接口up/down
当收到二层access口的报文时，若无对应虚接口不保活
如果是二层trunk口，则permit vlan根据是否存在虚接口决定是否保活。若无vlan tag或为pvid，则查找pvid对应虚接口决定是否保活。
需感知虚接口创建删除，ip地址变更，接口状态变更
##	报文处理
Switchapp适配所有端口上送arp报文
支持接收广播arp,免费arp，arp回复等报文进行发现
支持发送单播request报文进行保活
收包使用raw socket，结合cpu tag或vlan tag处理
发包使用raw socket(需三层口信息)或sdk接口(需二层口信息)
##	终端发现
目前仅利用arp报文进行终端发现及终端状态切换
##	终端维护
###	终端状态机
 状态机摘要：
```
(收到报文) -->ACTIVE
ACTIVE --(无流量 120s)--> PROBING --(3 次失败)--> 删除
ACTIVE --(接口 DOWN/arp request非同网段/vlan无对应虚接口)--> IFACE_INVALID --(30min)--> 删除
IFACE_INVALID --(接口 UP/接口Ip变为同网段/对应虚接口添加)--> PROBING
PROBING --(收到回应)--> ACTIVE
```
###	终端列表维护
保活与超时机制:按状态机图，每终端独立保活与超时检查
根据瑞昱竞分，报文发送可能需要进行分散，100ms一次包发送

单链表方案：定时轮询链表
频率低,遍历次数少,直接遍历链表
 
时间轮+时槽链表方案:单定时器进行每时槽处理
频率高,遍历次数多,需要提前计算分表
 
##	事件上报
支持查询所有终端信息
支持增量上报变化的终端信息

## 数据结构设计
仅样例:
terminal_manager_t 结构体，管理全部终端及定时器线程
成员:
head 链表,保存所有发现的终端结构体terminal_entry_t
count 终端数量
mutex 保护数据的互斥锁
timer_thread 定时器线程
running 是否运行状态，可用于结束timer_thread的运行

terminal_entry_t 结构体，保存发现终端
成员：
mac
ip
iface 接口名
state 保存对应状态机的状态
last_seen 上次发现的时间
last_probe_time 上次发送探测的时间
probe_fail_count 探测失败次数
metadata 预留结构体，可能与特定交换芯片收发包相关数据，比如vlanid,二层端口等
next 指向下一个terminal_entry_t终端结构体

metadata_t 结构体,保存可能与特定交换芯片收发包相关数据
成员：
logical_port(例子)
vlan(例子)